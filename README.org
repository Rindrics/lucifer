#:TITLE: tidyNAS
#:STARTUP: overview
* これは何か？
浮魚資源グループの NAS 内のデータを，使いやすい形で蓄積していくためのプロジェクト．

* プロジェクトの構成
** データフォーマットの決定
将来の横断的解析に堪えるためには，データをどのような形で蓄積してゆくべきかを議論し，データのフォーマットを決定する．
** 過去の蓄積データ統合・出力パッケージ/ reform_oldr
新しいデータフォーマットがいくら合理的だとしても，過去の蓄積データとの連続性がなくなってしまうのは問題である．
この問題に対処するために，過去の蓄積データを読み込んで統合し，新しい形に整形して出力することが必要である（reform_oldr パッケージ）．
*** 機能と関数イメージ
- merge_oldr(): これまで蓄積してきたデータを統合する
- conv2inputSheet(): 入力しやすいように野帳形式に変換する
- export_inputSheet(): 過去の全ての年ごとに出力する（あたかも，最初からその形式で入力されたかのように）
出力されるデータの命名規則は，inputSheet_YYYY_Routput.csv
** システム移行作業
過去のデータからの流れを断ち切るために，ここは敢えてパッケージに組み込まず，隔離しておく．
- シェルスクリプトで，ファイル名から_Routputを消去
- 今後のデータは inputSheet_YYYY.csv をgit管理下で蓄積していく
- 過去のデータに入力ミスが見つかった場合も，inputSheet_YYYY.csv を修正する
万一，過去の蓄積データの再出力が必要になっても，git管理下なので適宜"theirs"と"ours"を区別してマージ可能
** 現在以降のデータ蓄積パッケージ/ tidy_fishr
浮魚GのNASの中にあるデータの品質をチェックし，統合データとドキュメント類を出力するパッケージ．
*** 機能と関数イメージ
**** 品質チェック
***** check_colnames(): 行名
***** check_class(): 各行のクラス
***** warn_outlier(): 異常値について警告する．チェック済みを1にしたら，警告は抑制される．
異常値検出にはT2 統計量，Q 統計量を使う？
https://datachemeng.com/t2qstatistics/
**** 統合データ出力
***** 航海データの変形
trans_cruise()

入力に便利なフォーマットを，解析しやすいフォーマットに変形するためにこれが必要．

***** データ統合
build(measdir, otldir, crsdir=opt, range.yr=opt)

チェックを通過したものだけを統合．

チェック通過したかの値を保持しておく．

どれか1つのせいで全体のビルドが失敗しないようにする．

***** データの種類
****** 調査
- 採集
- CTD
- 測定台帳
- 耳石
- 鱗
- 脂質分析
****** 鮮魚等
- 測定台帳
- 耳石
- 鱗
- 脂質分析
**** データ目録を作成
make_list(data, outdir)
**** ディレクトリの見取り図を作成
tree -N ./ > dir_structure.txt
**** 入力シート，野帳を生成
make_sheets(outdir)

Imports: XLconnect

**** 要約図表を出力
- make_fig(data, outdir)
- make_table(data, outdir)

Imports: ggplot
**** ドキュメントを作成
make_docs(data, outdir, range)
LaTeX と連携
** CI部分
データ目録等のドキュメントと，実際のデータとの間に乖離を生じさせないために必要
- データの更新を監視しておく
- データ更新があるたびに上記パッケージの関数群が実行され，統合データとドキュメント類が自動的に出力される．

* 想定されるディレクトリ構造
- 航海データ/
  - 2017
  - 2018
    - 6月
      - 採集結果.csv
    - 8月
      - 採集結果.csv
- 測定データ/
  - survey2017.csv
  - survey2018.csv
  - sengyo2017.csv
  - sengyo2018.csv

- CTD/
  - 2017
    - st1.asc
    - st2.asc
    - ...
  - 2018
    - st2.asc
    - st1.asc
    - ...
  - tidyNAS/
    - README
    - I/O設定ファイル
    - figs/
      - Sc-j_blhist.pdf
      - Sc-j_blbw.pdf
      - Sc-j_agehist.pdf
      - Sc-j_hdate.pdf
      - Sc-j_cpue.pdf
      - Sc-a...
      - Ja-m...
      - Sa-m...
      - Et-t...
      - En-j...
  
    - tables/
      - all.pdf
      - 1997.pdf
      - ...
      - 2018.pdf
    - reports/
      - 1997.pdf
      - ...
      - 2018.pdf
      - ...
      - Sc-j.pdf
      - Sa-m.pdf
      - En-j.pdf
      - ...

* 維持していくために
- .xlsxが更新されたら自動でcsvが出力されるシェルスクリプト
* プロジェクトの流れ
** パッケージ化
** CI化
** 導入
* やらないこと
以下のデータの整備
- CTDデータ（海洋環境Gに任せる）
- NORPAC（生態系変動Gに任せる）
* ご意見をいただきたいこと
意見集約の場をGitHubのIssueに設けます．
- データ形式の使いやすさ（解析のしやすさ，入力のしやすさ，ファイルの見つけやすさ）について
- 各調査の呼称，各県データのサンプル名の規格化について
